name: Data Collection CronJob

on:
  schedule:
    - cron: '*/5 * * * *'
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Fetch API and Update JSON
      run: |
        import json
        import os
        import urllib.request
        from datetime import datetime

        # --- 1. 시간 및 URL 계산 ---
        now = datetime.now()
        current_minute = now.minute
        
        # 현재 분 + 1 계산
        todo_id = current_minute + 1
        url = f"https://jsonplaceholder.typicode.com/todos/{todo_id}"
        
        print(f"Target Time: {now.strftime('%H:%M')}, Target ID: {todo_id}")

        # --- 2. API 호출 ---
        try:
            with urllib.request.urlopen(url) as response:
                if response.status == 200:
                    data = json.loads(response.read().decode())
                    
                    # [여기서 타이틀을 내 맘대로 변경합니다]
                    # 예: "jurilee 수집데이터_시간 (원래ID)"
                    custom_title = f"jurilee 데이터_{now.strftime('%Y-%m-%d %H:%M')} (Source ID: {todo_id})"
                    
                    data['title'] = custom_title  # <--- 기존 title 덮어쓰기
                    data['collected_at'] = now.isoformat() # 수집 시간 기록
                    
                    print(f"Title changed to: {custom_title}")
                else:
                    print("Failed to fetch data")
                    exit(1)
        except Exception as e:
            print(f"Error fetching data: {e}")
            exit(1)

        # --- 3. 파일 저장 (Incremental) ---
        file_path = 'jurilee_test.json'
        existing_data = []

        if os.path.exists(file_path):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    existing_data = json.load(f)
            except json.JSONDecodeError:
                pass 

        existing_data.append(data)

        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(existing_data, f, indent=4, ensure_ascii=False)
        
        print(f"Successfully updated {file_path}")
      shell: python

    - name: Commit and Push changes
      run: |
        git config --global user.name "jurilee-bot"
        git config --global user.email "jurilee@users.noreply.github.com"
        
        git add jurilee_test.json
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update jurilee_test.json data [skip ci]"
          git pull --rebase origin main
          git push
        fi